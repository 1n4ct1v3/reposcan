{% extends "base.html" %}

{% block title %}DAST Scanner - RepoScan{% endblock %}

{% block content %}
<h1 class="page-title">Dynamic Application Security Testing (DAST)</h1>

<div class="container scan-container">
    <h2 class="section-title" style="margin-bottom: 10px;">
        OWASP ZAP Scanner
    </h2>

    <div class="scan-info">
        <p class="info-text">This scanner uses ZAP to perform automated security testing of your web application. Please ensure you have proper authorization to test the target URL.</p>
    </div>

    <div id="link" class="tab active">
        <form id="dast-form" onsubmit="submitDastForm(event)">
            <label for="target_url" class="form-label">Target URL:</label>
            <input type="text" id="target_url" name="target_url" class="form-input" placeholder="https://example.com" required>
            <p class="input-help">Enter the full URL of the target web application (e.g., https://example.com)</p>
            <input type="submit" class="form-submit" value="Start Scan">
        </form> 
    </div>

    <p id="message" class="scan-message">
        {% if error_message %}
            <div class="error-message">{{ error_message }}</div>
        {% endif %}
    </p>
</div>

<div class="container resources-container">
    <h2 class="section-title">
        <span class="icon-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="auto" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-text-icon lucide-book-text"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20"/><path d="M8 11h8"/><path d="M8 7h6"/></svg>
        </span>
        Security Resources
    </h2>
    <div class="resources-grid">
        <div class="resource-card" onclick="openModal('zap-info')">
            <div class="card-gradient">
                <div class="logo-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="42" height="auto" x="0" y="0" viewBox="0 0 64 64" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path d="m28.153 61.6 2.772-21.32H11.821c-1.654 0-2.671-1.809-1.812-3.222L31.934 1.025C33.125-.932 36.142.128 35.847 2.4l-2.772 21.327H52.18c1.654 0 2.671 1.809 1.812 3.222L32.066 62.976c-1.191 1.956-4.208.895-3.913-1.376z" fill="#ffffff" opacity="0.8" data-original="#000000"></path></g></svg>
                </div>
            </div>
            <div class="card-content">
                <h3>About OWASP ZAP</h3>
                <p>Understanding ZAP scanning capabilities and features</p>
            </div>
        </div>
        <div class="resource-card" onclick="openModal('scan-prep')">
            <div class="card-gradient">
                <div class="logo-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="42" height="auto" x="0" y="0" viewBox="0 0 24 24" style="enable-background:new 0 0 512 512" xml:space="preserve" class=""><g><path fill="#ffffff" d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81v8.38C2 19.83 4.17 22 7.81 22h8.38c3.64 0 5.81-2.17 5.81-5.81V7.81C22 4.17 19.83 2 16.19 2zM9.97 14.9l-2.25 2.25c-.15.15-.34.22-.53.22s-.39-.07-.53-.22l-.75-.75c-.3-.29-.3-.77 0-1.06.29-.29.76-.29 1.06 0l.22.22 1.72-1.72c.29-.29.76-.29 1.06 0 .29.29.29.77 0 1.06zm0-7-2.25 2.25c-.15.15-.34.22-.53.22s-.39-.07-.53-.22l-.75-.75c-.3-.29-.3-.77 0-1.06.29-.29.76-.29 1.06 0l.22.22 1.72-1.72c.29-.29.76-.29 1.06 0 .29.29.29.77 0 1.06zm7.59 8.72h-5.25c-.41 0-.75-.34-.75-.75s.34-.75.75-.75h5.25a.749.749 0 1 1 0 1.5zm0-7h-5.25c-.41 0-.75-.34-.75-.75s.34-.75.75-.75h5.25a.749.749 0 1 1 0 1.5z" opacity="0.8" data-original="#000000" class=""></path></g></svg>
                </div>
            </div>
            <div class="card-content">
                <h3>Scan Preparation</h3>
                <p>How to prepare for a successful security scan</p>
            </div>
        </div>
        <div class="resource-card" onclick="openModal('vulnerabilities')">
            <div class="card-gradient">
                <div class="logo-placeholder">
                    <svg width="42" height="auto" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="PublicIcon"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39" fill="#ffffff" opacity="0.8"></path></svg>
                </div>
            </div>
            <div class="card-content">
                <h3>Common Vulnerabilities</h3>
                <p>Understanding web application security vulnerabilities</p>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="zap-info" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('zap-info')">&times;</span>
        <h2>About OWASP ZAP</h2>
        <div class="modal-body">
            <h3>What is OWASP ZAP?</h3>
            <p>OWASP Zed Attack Proxy (ZAP) is the world's most widely used web application security scanner. It's actively maintained by a dedicated international team of volunteers.</p>
            
            <h3>How It Works</h3>
            <ul>
                <li><strong>Spider Crawling:</strong> Automatically discovers the structure of the target website</li>
                <li><strong>Active Scanning:</strong> Tests for security vulnerabilities by simulating attacks</li>
                <li><strong>Passive Analysis:</strong> Examines responses for security issues without active testing</li>
            </ul>

            <h3>What ZAP Tests For</h3>
            <ul>
                <li>SQL Injection vulnerabilities</li>
                <li>Cross-Site Scripting (XSS)</li>
                <li>Broken authentication</li>
                <li>Security misconfigurations</li>
                <li>Outdated security headers</li>
                <li>And many more...</li>
            </ul>
        </div>
    </div>
</div>

<div id="scan-prep" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('scan-prep')">&times;</span>
        <h2>Preparing for a Security Scan</h2>
        <div class="modal-body">
            <h3>Before Starting</h3>
            <ul>
                <li><strong>Authorization:</strong> Ensure you have permission to test the target</li>
                <li><strong>Backup:</strong> Have a recent backup of your system</li>
                <li><strong>Monitoring:</strong> Set up proper monitoring during the scan</li>
                <li><strong>Testing Environment:</strong> Preferably use a non-production environment</li>
            </ul>

            <h3>URL Requirements</h3>
            <ul>
                <li>Use complete URLs including protocol (https://)</li>
                <li>Ensure the target is accessible from the scanner</li>
                <li>Verify any required authentication is in place</li>
            </ul>

            <h3>Best Practices</h3>
            <ul>
                <li>Start with a baseline scan before full scanning</li>
                <li>Monitor system performance during scanning</li>
                <li>Review and validate findings after the scan</li>
                <li>Keep scan results confidential</li>
            </ul>
        </div>
    </div>
</div>

<div id="vulnerabilities" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('vulnerabilities')">&times;</span>
        <h2>Common Web Vulnerabilities</h2>
        <div class="modal-body">
            <h3>Security Vulnerabilities Detected by ZAP</h3>
            <ul>
                <li><strong>Injection Flaws</strong>
                    <ul>
                        <li>SQL Injection</li>
                        <li>Cross-Site Scripting (XSS)</li>
                        <li>Command Injection</li>
                    </ul>
                </li>
                <li><strong>Authentication Issues</strong>
                    <ul>
                        <li>Weak Password Policies</li>
                        <li>Session Management Flaws</li>
                        <li>Insecure Authentication Methods</li>
                    </ul>
                </li>
                <li><strong>Information Disclosure</strong>
                    <ul>
                        <li>Sensitive Data Exposure</li>
                        <li>Directory Listing</li>
                        <li>Information Leakage in Responses</li>
                    </ul>
                </li>
                <li><strong>Security Misconfigurations</strong>
                    <ul>
                        <li>Missing Security Headers</li>
                        <li>Default Credentials</li>
                        <li>Unnecessary Services Enabled</li>
                    </ul>
                </li>
                <li><strong>Access Control Issues</strong>
                    <ul>
                        <li>Insecure Direct Object References</li>
                        <li>Missing Function Level Access Control</li>
                        <li>Privilege Escalation</li>
                    </ul>
                </li>
            </ul>

            <div class="note-box">
                <strong>Note:</strong> The actual vulnerabilities detected may vary depending on your application's architecture and implementation.
            </div>
        </div>
    </div>
</div>

<style>
.scan-container {
    max-width: 1300px;
}

.scan-info {
    background-color: #e3f2fd;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.info-text {
    color: #444;
    margin: 0;
    line-height: 1.5;
}

.input-help {
    font-size: 0.9em;
    color: #666;
    margin-top: 4px;
    margin-bottom: 16px;
}

.scan-message {
    text-align: center;
    margin-top: 20px;
}

/* Resource Cards Styles */
.resources-container {
    margin-top: 2em;
}

.resources-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2em;
    padding: 1em;
}

.resource-card {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
}

.resource-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.card-gradient {
    height: 120px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.resource-card:nth-child(1) .card-gradient {
    background: linear-gradient(135deg, #6CB4EE, #0056b3);
}

.resource-card:nth-child(2) .card-gradient {
    background: linear-gradient(135deg, #FF9966, #FF5E62);
}

.resource-card:nth-child(3) .card-gradient {
    background: linear-gradient(135deg, #56ab2f, #a8e063);
}

.card-content {
    padding: 1.5em;
    background: #fff;
}

.card-content h3 {
    color: #333;
    margin-bottom: 0.5em;
}

.card-content p {
    color: #666;
    font-size: 0.9em;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 2em;
    border-radius: 8px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    color: #333;
}

.modal-content h2 {
    color: #007bff;
    margin-bottom: 1em;
}

.modal-content h3 {
    color: #0056b3;
    margin: 1em 0 0.5em 0;
}

.modal-body {
    line-height: 1.6;
}

.modal-body ul, .modal-body ol {
    margin-left: 1.5em;
    margin-bottom: 1em;
}

.modal-body li {
    margin-bottom: 0.5em;
}

.close {
    position: absolute;
    right: 20px;
    top: 10px;
    font-size: 28px;
    font-weight: bold;
    color: #666;
    cursor: pointer;
}

.close:hover {
    color: #007bff;
}

.section-title {
    text-align: left;
    margin: 0 0 20px 0;
    color: #444;
    display: flex;
    align-items: center;
    font-size: 1.8em;
}

.icon-placeholder {
    width: 32px;
    height: 32px;
    margin-right: 12px;
    background-color: #007bff;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-placeholder svg {
    color: white;
}

.note-box {
    background-color: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin-top: 20px;
    border-radius: 4px;
}

.error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 12px;
    border-radius: 4px;
    border: 1px solid #f5c6cb;
    margin: 10px 0;
    text-align: center;
}
</style>

<script>
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
        document.body.style.overflow = 'auto';
    }
});

async function submitDastForm(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const messageDiv = document.getElementById('message');
    
    try {
        const response = await fetch('/dast_scan', {
            method: 'POST',
            body: formData
        });
        
        if (response.redirected) {
            // If we get a redirect, follow it
            window.location.href = response.url;
            return;
        }
        
        const data = await response.text();
        
        // Create a temporary div to parse the HTML response
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data;
        
        // Find the error message in the response
        const errorMessage = tempDiv.querySelector('.error-message');
        
        if (errorMessage) {
            // Show the error message
            messageDiv.innerHTML = errorMessage.outerHTML;
        } else {
            // If no error, redirect to dashboard
            window.location.href = '/';
        }
    } catch (error) {
        messageDiv.innerHTML = `<div class="error-message">An error occurred: ${error.message}</div>`;
    }
}
</script>
{% endblock %}
